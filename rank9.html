<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Há»‡ Thá»‘ng Rank</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1e1e1e; color: white; }
    h1 { text-align: center; }
    input, button { padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 10px; text-align: center; }
    th { background: #333; }
    .reset-btn { margin-top: 10px; background: red; color: white; border: none; padding: 10px; cursor: pointer; }
    /* áº¨n mÅ©i tÃªn input number */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body>
  <h1>ğŸ† Báº£ng Xáº¿p Háº¡ng Rank</h1>

  <label>ğŸ‘¤ TÃªn ngÆ°á»i chÆ¡i: </label>
  <input type="text" id="playerName" maxlength="20" placeholder="Tá»‘i Ä‘a 20 kÃ½ tá»±">
  <label>ğŸ“Š Äiá»ƒm vá»«a Ä‘áº¡t: </label>
  <input type="text" id="scoreInput" placeholder="0-100">
  <button onclick="updateScore()">Cáº­p nháº­t Ä‘iá»ƒm</button>
  <button class="reset-btn" onclick="resetData()">XÃ³a dá»¯ liá»‡u</button>

  <table>
    <thead>
      <tr>
        <th>Háº¡ng</th>
        <th>TÃªn</th>
        <th>Äiá»ƒm hiá»‡n táº¡i</th>
        <th>Rank</th>
        <th>Tá»•ng Ä‘iá»ƒm</th>
      </tr>
    </thead>
    <tbody id="leaderboard"></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAY-Rwe1B2DRIB8JKcJzoQRy8RrTsx0yfI",
      authDomain: "leaderboard-630ca.firebaseapp.com",
      databaseURL: "https://leaderboard-630ca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "leaderboard-630ca",
      storageBucket: "leaderboard-630ca.firebasestorage.app",
      messagingSenderId: "998334286692",
      appId: "1:998334286692:web:9729de5ad0ee9c957d8871",
      measurementId: "G-MHBC7S6FW6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const rankThresholds = [
      { name: "Sáº¯t âš™ï¸", points: 100, color: "#555555" },
      { name: "Äá»“ng ğŸŸ¤", points: 300, color: "#8B4513" },
      { name: "Báº¡c âšª", points: 300, color: "#C0C0C0" },
      { name: "VÃ ng ğŸŸ¡", points: 300, color: "#FFD700" },
      { name: "Báº¡ch kim ğŸ”·", points: 500, color: "#40E0D0" },
      { name: "Kim cÆ°Æ¡ng ğŸ’", points: 750, color: "#1E90FF" },
      { name: "Tinh anh âš”ï¸", points: 1000, color: "#8A2BE2" },
      { name: "Cao thá»§ ğŸ‰", points: 1500, color: "#DC143C" },
      { name: "Äáº¡i cao thá»§ ğŸ¦…", points: 2000, color: "#8B0000" },
      { name: "Chiáº¿n tÆ°á»›ng ğŸ”¥", points: 3000, color: "#FF4500" },
      { name: "ThiÃªn vÆ°Æ¡ng ğŸŒŒ", points: 5000, color: "#4B0082" }
    ];

    // âœ… Cáº­p nháº­t Ä‘iá»ƒm
    async function updateScore() {
      const name = document.getElementById("playerName").value.trim();
      let score = parseInt(document.getElementById("scoreInput").value);
      if (!name || isNaN(score)) return;

      const snapshot = await get(child(ref(db), "players/" + name));
      let player = snapshot.exists() ? snapshot.val() : { name, points: 0, totalPoints: 0, rankIndex: -1 };

      player.points += score;
      player.totalPoints += score;

      // Xá»­ lÃ½ thÄƒng háº¡ng
      while (player.rankIndex + 1 < rankThresholds.length &&
            player.points >= rankThresholds[player.rankIndex + 1].points) {
        player.points -= rankThresholds[player.rankIndex + 1].points;
        player.rankIndex++;
      }

      await set(ref(db, "players/" + name), player);
      document.getElementById("scoreInput").value = "";
    }
    window.updateScore = updateScore;

    // âœ… Hiá»ƒn thá»‹ realtime
    function renderLeaderboard() {
      const playersRef = ref(db, "players");
      onValue(playersRef, (snapshot) => {
        const data = snapshot.val() || {};
        let players = Object.values(data);

        players.sort((a, b) => b.totalPoints - a.totalPoints);

        const tbody = document.getElementById("leaderboard");
        tbody.innerHTML = "";
        players.forEach((p, i) => {
          const color = (i < 10) ? "#FFD700" : (p.rankIndex === -1 ? "#222222" : rankThresholds[p.rankIndex].color);
          const rankName = (i < 10) ? "ThÃ¡ch Ä‘áº¥u ğŸ‘‘" : (p.rankIndex === -1 ? "ChÆ°a cÃ³ rank" : rankThresholds[p.rankIndex].name);

          const row = `<tr style="background:${color}; color:white;">
            <td>${i + 1}</td>
            <td>${p.name}</td>
            <td>${p.points}</td>
            <td>${rankName}</td>
            <td>${p.totalPoints}</td>
          </tr>`;
          tbody.innerHTML += row;
        });
      });
    }
    renderLeaderboard();

    // âœ… Reset toÃ n bá»™ dá»¯ liá»‡u
    async function resetData() {
      if (confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a toÃ n bá»™ dá»¯ liá»‡u khÃ´ng?")) {
        await set(ref(db, "players"), {});
      }
    }
    window.resetData = resetData;

    // Giá»¯ input nhÆ° cÅ©
    document.getElementById("scoreInput").addEventListener("input", function () {
      let val = this.value.replace(/[^0-9]/g, "");
      if (val === "100") { this.value = "100"; return; }
      if (val.length > 2) val = val.slice(0, 2);
      this.value = val;
    });
    document.getElementById("playerName").addEventListener("input", function () {
      if (this.value.length > 20) this.value = this.value.slice(0, 20);
    });
  </script>
</body>
</html>
